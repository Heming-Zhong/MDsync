<OCTYPE html>
    <html>

    <head>
        <meta charset="UTF-8">
        <title>主页</title>
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    </head>

    <body>
        <script>
            // const en = require('./client-encrypt')
            const rpc = require('./rpc')
            const {
                dialog
            } = require('electron').remote
        </script>
        <script>
            if (typeof module === 'object') {
                window.module = module;
                module = undefined;
            }
        </script>
        <!-- <script src="no           /jquery/3.1.1/jquery.min.js"></script> -->
        <script src="node_modules/jquery/dist/jquery.min.js"></script>
        <link rel="stylesheet" href="jstree/dist/themes/default/style.min.css" />
        <script src="jstree/dist/jstree.min.js"></script>
        <script>
            if (window.module) module = window.module;
        </script>
        <h1>主页</h1>

        <!-- <button onclick="test()">测试</button> -->

        <script>
            const ipc = require('electron').ipcRenderer
            ipc.on("filetree", (event, msg) => {
                $('#jstree1').jstree({
                    "core": msg,
                    "check_callback": true
                }).on('select_node.jstree', function(event, data) {
                    console.log(data.node);
                }).on('changed.jstree', function(event, data) {
                    console.log("-----------changed.jstree");
                    console.log("action:" + data.action);
                    console.log(data.node);
                });
            })
            $(function() {

                $('#jstree1').jstree({
                    "core": {
                        "data": [{
                            "id": "0",
                            "parent": "#",
                            "state": {
                                "disabled": false,
                                "opened": true,
                                "selected": false
                            },
                            "text": "夏宇信息",
                            "timestamp": 0,
                            "type": "dir"
                        }, {
                            "id": "69",
                            "parent": "0",
                            "text": "工程",
                            "timestamp": 0,
                            "type": "file"
                        }, {
                            "id": "5",
                            "parent": "0",
                            "text": "行政",
                            "timestamp": 0,
                            "type": "dir"
                        }, {
                            "id": "71",
                            "parent": "0",
                            "text": "迷",
                            "timestamp": 0,
                            "type": "dir"
                        }, {
                            "id": "1",
                            "parent": "0",
                            "text": "技术",
                            "timestamp": 0,
                            "type": "dir"
                        }],
                        "themes": {
                            "variant": "large", //加大
                            "ellipsis": true //文字多时省略
                        },
                        "check_callback": true
                    }
                }).on('select_node.jstree', function(event, data) {
                    var ref = $('#jstree1').jstree(true);
                    // var _l = data.node.li_attr;
                    console.log(data.node.original.type);
                    // 叶节点同时类型不是dir，说明是文件
                    if (ref.is_leaf(data.node) && data.node.original.type != 'dir') {
                        // TO-DO：获取文件内容
                        path = ref.get_path(data.node, '/')
                        console.log(path)

                        // if you click a file-node, that means download it
                        _download(data.node, path)
                    } else {
                        // 说明是目录，什么也不做
                    }
                }).on('changed.jstree', function(event, data) {
                    console.log("-----------changed.jstree");
                    console.log("action:" + data.action);
                    console.log(data.node);
                });

            });

            function upload() {
                ref = $('#jstree1').jstree(true)
                node = _getCurrNode()
                console.log(node)
                    // 只有选中非叶节点时才可以上传
                if (ref.is_leaf(node) && node.original.type != 'dir') {
                    alert("请选中一个目录！")
                } else {
                    // 打开选择文件对话框
                    dialog.showOpenDialog({
                        title: "请选择要上传的文件",
                    }).then(result => {
                        ref = $('#jstree1').jstree(true)
                        node = _getCurrNode()
                        console.log(result)
                        if (!result.canceled) {
                            filepaths = result.filePaths
                            cloudpath = ref.get_path(node, '/')
                            ipc.send("upload", {
                                localpath: filePaths,
                                cloudpath: cloudpath
                            })
                        } else {
                            console.log("upload canceled")
                        }
                    }).catch(err => {
                        console.log(err)
                    })
                }
            }

            function _download(node, path) {
                ipc.send("download", {
                    node: node,
                    path: path
                })
            }

            function createdir() {
                var ref = $('#jstree1').jstree(true);

                var currNode = _getCurrNode();
                if (ref.is_leaf(currNode)) {
                    currNode = ref.get
                }
                currNode = ref.create_node(currNode, {
                    "type": "file"
                });
                if (currNode) {
                    ref.edit(currNode);
                }
            }

            function rename() {
                var ref = $('#jstree1').jstree(true);
                var currNode = _getCurrNode();
                ref.rename_node(currNode, "rename node222");
            }

            function del() {
                var ref = $('#jstree1').jstree(true);
                var currNode = _getCurrNode();
                ref.delete_node(currNode);
            }

            function moveup() {
                var ref = $('#jstree1').jstree(true);
                var currNode = _getCurrNode();
                var prevNode = ref.get_prev_dom(currNode, true);
                ref.move_node(currNode, prevNode, 'before');
            }

            function movedown() {
                var ref = $('#jstree1').jstree(true);
                var currNode = _getCurrNode();
                var nextNode = ref.get_next_dom(currNode, true); //返回兄弟节点的下一个节点
                ref.move_node(currNode, nextNode, 'after');
            }

            /**
             *    获取当前所选中的结点
             */
            function _getCurrNode() {
                var ref = $('#jstree1').jstree(true),
                    sel = ref.get_selected();
                console.log(sel);
                if (!sel.length) {
                    console.log("----");
                    return false;
                }
                sel = sel[0];
                return sel;
            }
        </script>

        <body>
            <input type="button" value="create node" onclick="create();">
            <input type="button" value="rename node" onclick="rename();">
            <input type="button" value="del node" onclick="del();">
            <input type="button" value="上传" onclick="upload()">
            <input type="button" value="上移" onclick="moveup();">
            <input type="button" value="下移" onclick="movedown();">
            <div id="jstree1" style="width:200px;background:#fff322"></div>
        </body>


        <!-- <script>
            function test() {
                node = document.getElementById("container")
                console.log(node)
            }
        </script>
        <div id="container">
            <ul>
                <li>Root node
                    <ul>
                        <li>Child node 1</li>
                        <li>Child node 2</li>
                    </ul>
                </li>
            </ul>
        </div>
        <script>
            $(function() {
                $('#container').jstree();
            });
        </script> -->

    </body>

    </html>